<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ Online - Realtime</title>
    <style>
        /* --- CSS GI·ªÆ NGUY√äN --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #b30000; color: #fff; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #ffd700; text-shadow: 2px 2px 4px #000; margin-bottom: 20px; text-align: center; }
        
        .panel { background: #fff; padding: 30px; border-radius: 15px; color: #333; max-width: 500px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 20px; text-align: center; }
        
        input, textarea { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        button { background-color: #ffd700; color: #b30000; border: none; padding: 12px 20px; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 50px; margin: 5px; transition: 0.2s; }
        button:hover { background-color: #ffec8b; transform: scale(1.05); }
        button:disabled { background-color: #ccc; cursor: wait; transform: none; }
        button.secondary { background-color: #eee; color: #333; border: 1px solid #ccc; }
        button.danger { background-color: #ff4d4d; color: white; }
        
        .hidden { display: none !important; }
        
        /* Game Area */
        #game-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 1000px; width: 100%; margin-top: 20px; }
        .lixi-envelope { width: 80px; height: 110px; background: linear-gradient(135deg, #ff4d4d, #cc0000); border: 2px solid #ffd700; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 30px; user-select: none; position: relative; transition: 0.3s; }
        .lixi-envelope::before { content: "üßß"; }
        .lixi-envelope:hover { transform: translateY(-5px); }
        .lixi-envelope.opened { opacity: 0; transform: scale(0); pointer-events: none; }
        
        /* Player List */
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .player-item.active-turn { background-color: #e6fffa; border-left: 5px solid #00b894; }

        /* Notification Bar */
        #turn-notification { position: fixed; top: 10px; z-index: 2000; padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; }
        
        /* Modal Result */
        #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: #fff; color: #b30000; padding: 40px; border-radius: 20px; border: 4px solid #ffd700; text-align: center; animation: zoomIn 0.4s; position: relative; max-width: 90%; width: 400px; }
        .money-text { font-size: 40px; font-weight: 800; margin: 20px 0; color: #d60000; word-break: break-word; }
        @keyframes zoomIn { from {transform: scale(0);} to {transform: scale(1);} }
    </style>
</head>
<body>

    <h1>üßß L√å X√å ONLINE üßß</h1>
    
    <div id="turn-notification" class="hidden">...</div>

    <div id="login-panel" class="panel">
        <h3>Tham gia tr√≤ ch∆°i</h3>
        <input type="text" id="username" placeholder="T√™n c·ªßa b·∫°n (VD: G√¨ c≈©ng ƒë∆∞·ª£c)">
        <input type="text" id="room-id" placeholder="M√£ ph√≤ng (VD: TET2026)">
        <br>
        <button id="btn-join" onclick="window.joinGame('player')">V√†o Ch∆°i</button>
        <button id="btn-create" onclick="window.joinGame('admin')" class="secondary">T·∫°o Ph√≤ng (Admin)</button>
    </div>

    <div id="setup-panel" class="panel hidden">
        <h3 id="room-display">Ph√≤ng: ...</h3>
        
        <div id="admin-controls" class="hidden">
            <p><strong>C√†i ƒë·∫∑t ti·ªÅn (Admin):</strong></p>
            <textarea id="money-input" placeholder="Nh·∫≠p: 10k, 20k, 50k, 100k...">50k, 100k, 200k, 500k, 1tr</textarea>
            <button onclick="window.startGame()">B·∫ÆT ƒê·∫¶U GAME</button>
            <hr>
        </div>

        <div class="player-list">
            <h4>Danh s√°ch ng∆∞·ªùi ch∆°i:</h4>
            <div id="lobby-players">Loading...</div>
        </div>
    </div>

    <div id="game-panel" class="hidden">
        <div id="game-area"></div>
        
        <div id="admin-game-controls" class="panel hidden" style="margin-top: 20px;">
            <h3>ƒêi·ªÅu khi·ªÉn (Admin)</h3>
            <p>Ch·ªçn ng∆∞·ªùi ƒë·ªÉ m·ªùi m·ªü l√¨ x√¨:</p>
            <div id="active-player-list"></div>
            <hr>
            <button onclick="window.resetGame()" class="danger">‚Ü∫ RESET GAME (V√°n M·ªõi)</button>
        </div>
    </div>

    <div id="result-modal" class="hidden">
        <div class="modal-content">
            <h2 id="result-title">üéâ CH√öC M·ª™NG üéâ</h2>
            <p id="result-winner" style="font-size: 18px; color: #333;">...</p>
            <div class="money-text" id="result-amount">0 ƒë</div>
            <button onclick="window.closeModal()">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Th√™m 'get' v√† 'child' v√†o import
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect, get, child } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyA3yMvVIjxySUYIFsjMLG98rrzLQbcZiFM",
          authDomain: "game-li-xi-tet.firebaseapp.com",
          databaseURL: "https://game-li-xi-tet-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "game-li-xi-tet",
          storageBucket: "game-li-xi-tet.firebasestorage.app",
          messagingSenderId: "584090681077",
          appId: "1:584090681077:web:27c09dc5e0d6e149fa8fbc"
        };
        // -----------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myId = localStorage.getItem('myId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('myId', myId);
        let myName = "";
        let roomId = "";
        let isAdmin = false;
        let lastResultTimestamp = 0; 

        // --- PUBLIC FUNCTIONS ---

        window.joinGame = function(role) {
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('room-id').value.trim().toUpperCase();
            
            if (!myName || !roomId) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");

            const btnJoin = document.getElementById('btn-join');
            const btnCreate = document.getElementById('btn-create');
            
            // Kh√≥a n√∫t ƒë·ªÉ tr√°nh b·∫•m nhi·ªÅu l·∫ßn
            btnJoin.disabled = true;
            btnCreate.disabled = true;
            btnJoin.innerText = "ƒêang ki·ªÉm tra...";

            const roomRef = ref(db, `rooms/${roomId}`);

            // Ki·ªÉm tra ph√≤ng c√≥ t·ªìn t·∫°i kh√¥ng
            get(roomRef).then((snapshot) => {
                const exists = snapshot.exists();

                // N·∫æU L√Ä NG∆Ø·ªúI CH∆†I M√Ä PH√íNG KH√îNG T·ªíN T·∫†I -> B√ÅO L·ªñI
                if (role === 'player' && !exists) {
                    alert(`‚ùå Ph√≤ng "${roomId}" ch∆∞a ƒë∆∞·ª£c t·∫°o!\nVui l√≤ng li√™n h·ªá Admin ho·∫∑c ki·ªÉm tra l·∫°i m√£ ph√≤ng.`);
                    // M·ªü kh√≥a l·∫°i n√∫t
                    btnJoin.disabled = false;
                    btnCreate.disabled = false;
                    btnJoin.innerText = "V√†o Ch∆°i";
                    return; 
                }

                // N·∫øu l√† Admin ho·∫∑c ph√≤ng ƒë√£ t·ªìn t·∫°i -> Ti·∫øp t·ª•c ƒëƒÉng nh·∫≠p
                isAdmin = (role === 'admin');
                proceedLogin(role);

            }).catch((error) => {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi Firebase!");
                btnJoin.disabled = false;
                btnCreate.disabled = false;
                btnJoin.innerText = "V√†o Ch∆°i";
            });
        };

        function proceedLogin(role) {
            // L∆∞u info ng∆∞·ªùi ch∆°i
            const userRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(userRef, { name: myName, role: role, online: true });
            onDisconnect(userRef).remove();

            // Chuy·ªÉn UI
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('room-display').innerText = `Ph√≤ng: ${roomId} (${role === 'admin' ? 'Admin' : 'Player'})`;

            if (isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('admin-game-controls').classList.remove('hidden');
            }

            listenToGame();
        }

        window.startGame = function() {
            const input = document.getElementById('money-input').value;
            const amounts = parseMoneyInput(input);
            if (amounts.length === 0) return alert("Ch∆∞a nh·∫≠p ti·ªÅn!");

            const lixis = amounts.sort(() => 0.5 - Math.random()).map((amt, idx) => ({
                id: idx, amount: amt, opened: false
            }));

            update(ref(db, `rooms/${roomId}`), {
                status: 'playing',
                lixis: lixis,
                currentTurn: null,
                lastResult: null
            });
        };

        window.resetGame = function() {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën Reset ƒë·ªÉ ch∆°i v√°n m·ªõi kh√¥ng?")) return;
            update(ref(db, `rooms/${roomId}`), {
                status: 'setup',
                lixis: [],
                currentTurn: null,
                lastResult: null
            });
        };

        window.pickPlayer = function(playerId) {
            update(ref(db, `rooms/${roomId}`), { currentTurn: playerId });
        };

        window.closeModal = function() {
            document.getElementById('result-modal').classList.add('hidden');
        };

        // --- LOGIC GAME ---

        function listenToGame() {
            const roomRef = ref(db, `rooms/${roomId}`);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                if (data.status === 'playing') {
                    document.getElementById('setup-panel').classList.add('hidden');
                    document.getElementById('game-panel').classList.remove('hidden');
                    renderLixis(data.lixis || []);
                } else {
                    document.getElementById('game-panel').classList.add('hidden');
                    document.getElementById('setup-panel').classList.remove('hidden');
                }

                renderPlayerList(data.players || {}, data.currentTurn);
                updateNotification(data.currentTurn);

                if (data.lastResult && data.lastResult.timestamp !== lastResultTimestamp) {
                    lastResultTimestamp = data.lastResult.timestamp;
                    showGlobalResult(data.lastResult);
                }
            });
        }

        function renderLixis(lixis) {
            const gameArea = document.getElementById('game-area');
            if (gameArea.childElementCount !== lixis.length) {
                gameArea.innerHTML = '';
                lixis.forEach((lixi, index) => {
                    const el = document.createElement('div');
                    el.className = 'lixi-envelope';
                    el.id = `lixi-${index}`;
                    el.onclick = () => handleOpenLixi(index);
                    gameArea.appendChild(el);
                });
            }
            lixis.forEach((lixi, index) => {
                const el = document.getElementById(`lixi-${index}`);
                if (el && lixi.opened) el.classList.add('opened');
            });
        }

        function handleOpenLixi(index) {
            const roomRef = ref(db, `rooms/${roomId}`);
            onValue(roomRef, (snap) => {
                const d = snap.val();
                if (d.currentTurn !== myId) return alert("Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n!");
                if (d.lixis[index].opened) return alert("Bao n√†y ƒë√£ m·ªü!");

                const amount = d.lixis[index].amount;
                update(ref(db), {
                    [`rooms/${roomId}/lixis/${index}/opened`]: true,
                    [`rooms/${roomId}/currentTurn`]: null,
                    [`rooms/${roomId}/lastResult`]: {
                        winnerName: myName,
                        amount: amount,
                        timestamp: Date.now()
                    }
                });
            }, { onlyOnce: true });
        }

        function showGlobalResult(result) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const winnerText = document.getElementById('result-winner');
            const amountText = document.getElementById('result-amount');

            amountText.innerText = formatMoney(result.amount);
            
            if (result.winnerName === myName) {
                title.innerText = "üéâ B·∫†N ƒê√É NH·∫¨N ƒê∆Ø·ª¢C üéâ";
                winnerText.innerText = "Ch√∫c m·ª´ng nƒÉm m·ªõi ph√°t t√†i!";
            } else {
                title.innerText = "üîî K·∫æT QU·∫¢ L√å X√å üîî";
                winnerText.innerText = `Ch√∫c m·ª´ng ${result.winnerName} ƒë√£ m·ªü ƒë∆∞·ª£c:`;
            }
            modal.classList.remove('hidden');
        }

        function updateNotification(turnId) {
            const notif = document.getElementById('turn-notification');
            if (turnId) {
                notif.classList.remove('hidden');
                if (turnId === myId) {
                    notif.innerText = "üëâ ƒê·∫æN L∆Ø·ª¢T B·∫†N! H√ÉY CH·ªåN 1 BAO L√å X√å";
                    notif.style.background = "#ffd700";
                    notif.style.color = "#b30000";
                } else {
                    notif.innerText = "‚è≥ ƒêang ch·ªù ng∆∞·ªùi ch∆°i ch·ªçn...";
                    notif.style.background = "#fff";
                    notif.style.color = "#333";
                }
            } else {
                notif.classList.add('hidden');
            }
        }

        function renderPlayerList(players, currentTurnId) {
            const listHtml = Object.entries(players).map(([id, p]) => {
                const isTurn = id === currentTurnId;
                let btn = '';
                if (isAdmin) { 
                    btn = `<button onclick="window.pickPlayer('${id}')" style="font-size:12px; padding:5px 10px">M·ªùi</button>`;
                }
                return `
                    <div class="player-item ${isTurn ? 'active-turn' : ''}">
                        <span>${p.name} ${isTurn ? '‚≠ê' : ''}</span>
                        ${btn}
                    </div>
                `;
            }).join('');
            document.getElementById('lobby-players').innerHTML = listHtml;
            if (isAdmin) document.getElementById('active-player-list').innerHTML = listHtml;
        }

        function parseMoneyInput(str) {
            return str.split(',').map(s => {
                s = s.toLowerCase().trim();
                let m = 1;
                if (s.includes('tr')) m = 1000000;
                else if (s.includes('k')) m = 1000;
                return parseFloat(s.replace(/[^0-9.]/g,'')) * m;
            }).filter(n => n > 0);
        }

        function formatMoney(n) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        }
    </script>
</body>
</html>
