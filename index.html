<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ Online - S·ª≠a L·ªói</title>
    <style>
        /* CSS GI·ªÆ NGUY√äN */
        body { font-family: 'Segoe UI', sans-serif; background-color: #b30000; color: #fff; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #ffd700; text-shadow: 2px 2px 4px #000; margin-bottom: 20px; text-align: center; }
        .panel { background: #fff; padding: 30px; border-radius: 15px; color: #333; max-width: 500px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 20px; text-align: center; }
        input, textarea { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; }
        button { background-color: #ffd700; color: #b30000; border: none; padding: 12px 30px; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 50px; margin: 5px; }
        button:hover { background-color: #ffec8b; }
        .hidden { display: none !important; }
        
        /* Game Area */
        #game-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 1000px; width: 100%; margin-top: 20px; }
        .lixi-envelope { width: 80px; height: 110px; background: linear-gradient(135deg, #ff4d4d, #cc0000); border: 2px solid #ffd700; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 30px; user-select: none; position: relative; }
        .lixi-envelope::before { content: "üßß"; }
        .lixi-envelope.opened { opacity: 0; transform: scale(0); transition: all 0.5s; pointer-events: none; }
        
        /* Admin Controls */
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .player-item.active-turn { background-color: #e6fffa; border-left: 5px solid #00b894; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; }
        .status-picking { background: #ffd700; color: #b30000; font-weight: bold; }

        /* Modal Result */
        #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: #fff; color: #b30000; padding: 40px; border-radius: 20px; border: 4px solid #ffd700; text-align: center; animation: zoomIn 0.4s; }
        .money-text { font-size: 40px; font-weight: 800; margin: 20px 0; color: #d60000; }
        @keyframes zoomIn { from {transform: scale(0);} to {transform: scale(1);} }
    </style>
</head>
<body>

    <h1>üßß L√å X√å ONLINE üßß</h1>
    
    <div id="turn-notification" style="background:#fff; color:#333; padding:10px 20px; border-radius:20px; margin-bottom:10px;" class="hidden">...</div>

    <div id="login-panel" class="panel">
        <h3>Tham gia tr√≤ ch∆°i</h3>
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <input type="text" id="room-id" placeholder="M√£ ph√≤ng (V√≠ d·ª•: TET2026)">
        <br>
        <button onclick="window.joinGame('player')">V√†o Ch∆°i</button>
        <button onclick="window.joinGame('admin')" style="background-color: #eee; color: #333;">T·∫°o Ph√≤ng (Admin)</button>
    </div>

    <div id="setup-panel" class="panel hidden">
        <h3 id="room-display">Ph√≤ng: ...</h3>
        
        <div id="admin-controls" class="hidden">
            <p>C√†i ƒë·∫∑t l√¨ x√¨ (Admin):</p>
            <textarea id="money-input" placeholder="V√≠ d·ª•: 50k, 100k, 200k...">10k, 20k, 50k, 100k</textarea>
            <button onclick="window.startGame()">B·∫ÆT ƒê·∫¶U GAME</button>
            <hr>
        </div>

        <div class="player-list">
            <h4>Danh s√°ch ng∆∞·ªùi ch∆°i:</h4>
            <div id="lobby-players">Loading...</div>
        </div>
    </div>

    <div id="game-panel" class="hidden">
        <div id="game-area"></div>
        
        <div id="admin-game-controls" class="panel hidden" style="margin-top: 20px;">
            <h3>ƒêi·ªÅu khi·ªÉn (Admin)</h3>
            <p>B·∫•m "M·ªùi" ƒë·ªÉ ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c ch·ªçn l√¨ x√¨:</p>
            <div id="active-player-list"></div>
        </div>
    </div>

    <div id="result-modal" class="hidden">
        <div class="modal-content">
            <h2>üéâ CH√öC M·ª™NG üéâ</h2>
            <div class="money-text" id="result-amount">0 ƒë</div>
            <button onclick="window.closeModal()">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        // D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // ==========================================
        const firebaseConfig = {
            apiKey: "D√ÅN_API_KEY_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY",
            authDomain: "PROJECT_ID.firebaseapp.com",
            databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        // ==========================================

        console.log("Script ƒëang kh·ªüi ch·∫°y...");
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myId = localStorage.getItem('myId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('myId', myId);
        let myName = "";
        let roomId = "";
        let isAdmin = false;

        // --- G√ÅN H√ÄM RA WINDOW ƒê·ªÇ HTML G·ªåI ƒê∆Ø·ª¢C ---
        
        // 1. H√†m Join Game
        window.joinGame = function(role) {
            console.log("Join game called", role);
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('room-id').value.trim().toUpperCase();

            if (!myName || !roomId) {
                alert("Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng!");
                return;
            }

            isAdmin = (role === 'admin');

            const userRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(userRef, { name: myName, role: role, online: true });
            onDisconnect(userRef).remove();

            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('room-display').innerText = `Ph√≤ng: ${roomId}`;

            if (isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('admin-game-controls').classList.remove('hidden');
            }

            listenToGame();
        };

        // 2. H√†m Start Game (Admin)
        window.startGame = function() {
            const input = document.getElementById('money-input').value;
            const amounts = parseMoneyInput(input);
            if (amounts.length === 0) return alert("Ch∆∞a nh·∫≠p ti·ªÅn!");

            const lixis = amounts.sort(() => 0.5 - Math.random()).map((amt, idx) => ({
                id: idx, amount: amt, opened: false
            }));

            update(ref(db, `rooms/${roomId}`), {
                status: 'playing',
                lixis: lixis,
                currentTurn: null
            });
        };

        // 3. H√†m Pick Player (S·ª¨A L·ªñI ·ªû ƒê√ÇY)
        window.pickPlayer = function(playerId) {
            console.log("Admin ch·ªçn ng∆∞·ªùi ch∆°i:", playerId);
            update(ref(db, `rooms/${roomId}`), {
                currentTurn: playerId
            }).catch(err => alert("L·ªói c·∫≠p nh·∫≠t: " + err.message));
        };

        // 4. H√†m ƒê√≥ng Modal
        window.closeModal = function() {
            document.getElementById('result-modal').classList.add('hidden');
        };

        // --- C√ÅC H√ÄM N·ªòI B·ªò (KH√îNG C·∫¶N G·ªåI T·ª™ HTML) ---

        function listenToGame() {
            const roomRef = ref(db, `rooms/${roomId}`);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i
                renderPlayerList(data.players || {}, data.currentTurn);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i game
                if (data.status === 'playing') {
                    document.getElementById('setup-panel').classList.add('hidden');
                    document.getElementById('game-panel').classList.remove('hidden');
                    renderLixis(data.lixis || []);
                }

                // Th√¥ng b√°o l∆∞·ª£t ch∆°i
                const notif = document.getElementById('turn-notification');
                if (data.currentTurn) {
                    notif.classList.remove('hidden');
                    if (data.currentTurn === myId) {
                        notif.innerText = "üëâ ƒê·∫æN L∆Ø·ª¢T B·∫†N CH·ªåN L√å X√å!";
                        notif.style.background = "#ffd700";
                    } else {
                        notif.innerText = "‚è≥ ƒêang ƒë·ª£i ng∆∞·ªùi kh√°c ch·ªçn...";
                        notif.style.background = "#fff";
                    }
                } else {
                    notif.innerText = "Ch·ªù Admin m·ªùi...";
                }
            });
        }

        function renderPlayerList(players, currentTurnId) {
            const listHtml = Object.entries(players).map(([id, p]) => {
                const isTurn = id === currentTurnId;
                // N√∫t m·ªùi ch·ªâ hi·ªán n·∫øu m√¨nh l√† Admin v√† kh√¥ng ph·∫£i l√† ng∆∞·ªùi ch∆°i ƒë√≥
                let actionBtn = '';
                if (isAdmin) {
                    // Ch√∫ √Ω d·∫•u nh√°y ƒë∆°n ' quanh id
                    actionBtn = `<button onclick="window.pickPlayer('${id}')">M·ªùi</button>`;
                }

                return `
                    <div class="player-item ${isTurn ? 'active-turn' : ''}">
                        <span>${p.name} ${isTurn ? '‚≠ê' : ''}</span>
                        ${actionBtn}
                    </div>
                `;
            }).join('');

            document.getElementById('lobby-players').innerHTML = listHtml;
            if (isAdmin) document.getElementById('active-player-list').innerHTML = listHtml;
        }

        function renderLixis(lixis) {
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = ''; // X√≥a c≈© v·∫Ω m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
            
            lixis.forEach((lixi, index) => {
                const el = document.createElement('div');
                el.className = 'lixi-envelope';
                if (lixi.opened) el.classList.add('opened');

                // S·ª± ki·ªán click m·ªü l√¨ x√¨
                el.onclick = () => {
                    const roomRef = ref(db, `rooms/${roomId}`);
                    // D√πng get ƒë·ªÉ ki·ªÉm tra ch√≠nh x√°c 1 l·∫ßn
                    onValue(roomRef, (snap) => {
                        const d = snap.val();
                        if (d.currentTurn !== myId) return alert("Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n!");
                        if (d.lixis[index].opened) return alert("Bao n√†y m·ªü r·ªìi!");

                        // M·ªü
                        update(ref(db), {
                            [`rooms/${roomId}/lixis/${index}/opened`]: true,
                            [`rooms/${roomId}/currentTurn`]: null
                        });
                        
                        // Hi·ªán k·∫øt qu·∫£
                        document.getElementById('result-amount').innerText = formatMoney(d.lixis[index].amount);
                        document.getElementById('result-modal').classList.remove('hidden');

                    }, { onlyOnce: true });
                };
                gameArea.appendChild(el);
            });
        }

        function parseMoneyInput(str) {
            return str.split(',').map(s => {
                s = s.toLowerCase().trim();
                let m = 1;
                if (s.includes('tr')) m = 1000000;
                else if (s.includes('k')) m = 1000;
                return parseFloat(s.replace(/[^0-9.]/g,'')) * m;
            }).filter(n => n > 0);
        }

        function formatMoney(n) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        }
    </script>
</body>
</html>
