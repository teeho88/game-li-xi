<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ Online - Th·ªùi Gian Th·ª±c</title>
    <style>
        /* --- CSS GI·ªÆ NGUY√äN NH∆Ø C≈®, C√ì TH√äM PH·∫¶N LOGIN --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #b30000; color: #fff; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #ffd700; text-shadow: 2px 2px 4px #000; margin-bottom: 20px; text-align: center; }
        
        .panel { background: #fff; padding: 30px; border-radius: 15px; color: #333; max-width: 500px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 20px; text-align: center; }
        input, textarea { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; }
        button { background-color: #ffd700; color: #b30000; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 50px; margin: 5px; }
        button:hover { background-color: #ffec8b; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .hidden { display: none !important; }
        
        /* Game Area */
        #game-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 1000px; width: 100%; }
        .lixi-envelope { width: 80px; height: 110px; background: linear-gradient(135deg, #ff4d4d, #cc0000); border: 2px solid #ffd700; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 30px; user-select: none; position: relative; }
        .lixi-envelope::before { content: "üßß"; }
        .lixi-envelope.opened { opacity: 0; transform: scale(0); transition: all 0.5s; pointer-events: none; }
        
        /* Admin Controls */
        .player-list { text-align: left; margin-top: 20px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .player-item.active-turn { background-color: #e6fffa; border-left: 5px solid #00b894; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; }
        .status-picking { background: #ffd700; color: #b30000; font-weight: bold; }

        /* Notification */
        #turn-notification { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #fff; color: #b30000; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; }
        
        /* Modal Result */
        #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: #fff; color: #b30000; padding: 40px; border-radius: 20px; border: 4px solid #ffd700; text-align: center; animation: zoomIn 0.4s; }
        .money-text { font-size: 40px; font-weight: 800; margin: 20px 0; color: #d60000; }
        @keyframes zoomIn { from {transform: scale(0);} to {transform: scale(1);} }
    </style>
</head>
<body>

    <h1>üßß L√å X√å ONLINE üßß</h1>
    
    <div id="turn-notification" class="hidden">ƒêang ch·ªù Admin...</div>

    <div id="login-panel" class="panel">
        <h3>Tham gia tr√≤ ch∆°i</h3>
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <input type="text" id="room-id" placeholder="M√£ ph√≤ng (V√≠ d·ª•: TET2026)">
        <br>
        <button onclick="joinGame('player')">V√†o Ch∆°i</button>
        <button onclick="joinGame('admin')" style="background-color: #fff; color: #555; border: 1px solid #ccc;">T·∫°o Ph√≤ng (Admin)</button>
    </div>

    <div id="setup-panel" class="panel hidden">
        <h3 id="room-display">Ph√≤ng: ...</h3>
        <div id="admin-controls" class="hidden">
            <p>C√†i ƒë·∫∑t l√¨ x√¨ (Admin):</p>
            <textarea id="money-input" placeholder="V√≠ d·ª•: 50k, 100k, 200k, 500k...">10k, 20k, 50k, 100k</textarea>
            <button onclick="startGame()">B·∫ÆT ƒê·∫¶U GAME</button>
            <hr>
        </div>
        <div class="player-list">
            <h4>Danh s√°ch ng∆∞·ªùi ch∆°i:</h4>
            <div id="lobby-players">Loading...</div>
        </div>
    </div>

    <div id="game-panel" class="hidden">
        <div id="game-area"></div>
        
        <div id="admin-game-controls" class="panel hidden" style="margin-top: 20px;">
            <h3>ƒêi·ªÅu khi·ªÉn (Admin)</h3>
            <p>Ch·ªçn ng∆∞·ªùi ch∆°i ƒë·ªÉ c·∫•p quy·ªÅn m·ªü l√¨ x√¨:</p>
            <div id="active-player-list"></div>
        </div>
    </div>

    <div id="result-modal" class="hidden">
        <div class="modal-content">
            <h2>üéâ CH√öC M·ª™NG üéâ</h2>
            <p id="winner-name"></p>
            <div class="money-text" id="result-amount">0 ƒë</div>
            <button onclick="closeModal()">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, remove, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ============================================================
        // 1. C·∫§U H√åNH FIREBASE (B·∫†N PH·∫¢I THAY ƒê·ªîI PH·∫¶N N√ÄY)
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA3yMvVIjxySUYIFsjMLG98rrzLQbcZiFM",
            authDomain: "game-li-xi-tet.firebaseapp.com",
            databaseURL: "https://game-li-xi-tet-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-li-xi-tet",
            storageBucket: "game-li-xi-tet.firebasestorage.app",
            messagingSenderId: "584090681077",
            appId: "1:584090681077:web:27c09dc5e0d6e149fa8fbc"
        };
        // ============================================================

        // Kh·ªüi t·∫°o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Bi·∫øn to√†n c·ª•c
        let myId = localStorage.getItem('myId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('myId', myId);
        let myName = "";
        let roomId = "";
        let isAdmin = false;
        let currentLixiData = [];

        // Expose functions to window scope for HTML onclick
        window.joinGame = joinGame;
        window.startGame = startGame;
        window.closeModal = closeModal;
        window.pickPlayer = pickPlayer;

        // --- X·ª¨ L√ù LOGIC ---

        function joinGame(role) {
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('room-id').value.trim().toUpperCase();

            if (!myName || !roomId) {
                alert("Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng!");
                return;
            }

            isAdmin = (role === 'admin');

            // L∆∞u ng∆∞·ªùi ch∆°i v√†o DB
            const userRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(userRef, {
                name: myName,
                role: role,
                online: true
            });
            onDisconnect(userRef).remove(); // T·ª± x√≥a khi m·∫•t m·∫°ng/tho√°t

            // Chuy·ªÉn m√†n h√¨nh
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('room-display').innerText = `Ph√≤ng: ${roomId} (${role === 'admin' ? 'Quy·ªÅn Admin' : 'Ng∆∞·ªùi ch∆°i'})`;

            if (isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('admin-game-controls').classList.remove('hidden');
            }

            // L·∫ÆNG NGHE D·ªÆ LI·ªÜU T·ª™ SERVER
            listenToGame();
        }

        function listenToGame() {
            const roomRef = ref(db, `rooms/${roomId}`);

            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // 1. C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i (Lobby & Admin Panel)
                updatePlayerLists(data.players || {}, data.currentTurn);

                // 2. Ki·ªÉm tra tr·∫°ng th√°i Game
                if (data.status === 'playing') {
                    document.getElementById('setup-panel').classList.add('hidden');
                    document.getElementById('game-panel').classList.remove('hidden');
                    
                    // Render L√¨ x√¨ n·∫øu ch∆∞a c√≥ ho·∫∑c c√≥ thay ƒë·ªïi
                    if (!currentLixiData.length && data.lixis) {
                        currentLixiData = data.lixis;
                        renderLixis(data.lixis);
                    } else if (data.lixis) {
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªü/ƒë√≥ng
                        updateLixisUI(data.lixis);
                    }
                }

                // 3. X·ª≠ l√Ω l∆∞·ª£t ch∆°i
                handleTurn(data.currentTurn, data.lastWinner);
            });
        }

        // --- H√ÄM CHO ADMIN ---

        function startGame() {
            const input = document.getElementById('money-input').value;
            const amounts = parseMoneyInput(input);
            if (amounts.length === 0) return alert("Ch∆∞a nh·∫≠p ti·ªÅn!");

            // X√°o tr·ªôn v√† t·∫°o d·ªØ li·ªáu l√¨ x√¨
            const shuffled = amounts.sort(() => 0.5 - Math.random());
            const lixis = shuffled.map((amt, idx) => ({
                id: idx,
                amount: amt,
                opened: false
            }));

            // ƒê·∫©y l√™n Server
            update(ref(db, `rooms/${roomId}`), {
                status: 'playing',
                lixis: lixis,
                currentTurn: null,
                lastWinner: null
            });
        }

        window.pickPlayer = function(playerId) {
            update(ref(db, `rooms/${roomId}`), {
                currentTurn: playerId
            });
        }

        // --- H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ---

        function updatePlayerLists(players, currentTurnId) {
            const listHtml = Object.entries(players).map(([id, p]) => {
                const isTurn = id === currentTurnId;
                const status = isTurn ? '<span class="status-badge status-picking">ƒêang ch·ªçn...</span>' : '';
                
                // HTML cho Admin ch·ªçn ng∆∞·ªùi
                let adminBtn = '';
                if (isAdmin && id !== myId) { // Admin kh√¥ng t·ª± ch·ªçn m√¨nh (ho·∫∑c c√≥ th·ªÉ n·∫øu mu·ªën)
                    adminBtn = `<button style="font-size:12px; padding:5px 10px" onclick="pickPlayer('${id}')">M·ªùi ch·ªçn</button>`;
                }

                return `
                    <div class="player-item ${isTurn ? 'active-turn' : ''}">
                        <div>
                            <strong>${p.name}</strong> ${p.role === 'admin' ? '(Admin)' : ''}
                            ${status}
                        </div>
                        ${adminBtn}
                    </div>
                `;
            }).join('');

            document.getElementById('lobby-players').innerHTML = listHtml;
            if (isAdmin) document.getElementById('active-player-list').innerHTML = listHtml;
        }

        function renderLixis(lixis) {
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';
            lixis.forEach((lixi, index) => {
                const el = document.createElement('div');
                el.className = 'lixi-envelope';
                el.id = `lixi-${index}`;
                if (lixi.opened) el.classList.add('opened');
                
                el.onclick = () => openLixi(index);
                gameArea.appendChild(el);
            });
        }

        function updateLixisUI(lixis) {
            lixis.forEach((lixi, index) => {
                const el = document.getElementById(`lixi-${index}`);
                if (el && lixi.opened && !el.classList.contains('opened')) {
                    el.classList.add('opened');
                }
            });
        }

        function handleTurn(turnId, lastWinner) {
            const notif = document.getElementById('turn-notification');
            
            // X·ª≠ l√Ω hi·ªÉn th·ªã ng∆∞·ªùi tr√∫ng gi·∫£i
            if (lastWinner && lastWinner.time > Date.now() - 5000) { // Ch·ªâ hi·ªán trong 5s ƒë·∫ßu
                 // Logic hi·ªÉn th·ªã popup ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü openLixi ho·∫∑c listener ri√™ng n·∫øu c·∫ßn
                 // ·ªû ƒë√¢y ƒë∆°n gi·∫£n h√≥a: Ai click ng∆∞·ªùi n·∫•y th·∫•y, 
                 // ho·∫∑c Admin th√¥ng b√°o. ƒê·ªÉ ƒë∆°n gi·∫£n, popup ch·ªâ hi·ªán cho ng∆∞·ªùi click.
            }

            if (turnId) {
                notif.classList.remove('hidden');
                if (turnId === myId) {
                    notif.innerText = "üëâ ƒê·∫æN L∆Ø·ª¢T B·∫†N! H√ÉY CH·ªåN 1 BAO L√å X√å";
                    notif.style.backgroundColor = "#ffd700";
                    notif.style.color = "#b30000";
                } else {
                    // T√¨m t√™n ng∆∞·ªùi ƒëang ch∆°i
                    const playerItems = document.querySelectorAll('.player-item'); // C√°ch nhanh nh·∫•t l·∫•y text
                    // (Th·ª±c t·∫ø n√™n l·∫•y t·ª´ data players nh∆∞ng ƒë·ªÉ ƒë∆°n gi·∫£n code)
                    notif.innerText = `‚è≥ ƒêang ƒë·ª£i ng∆∞·ªùi ch∆°i kh√°c ch·ªçn...`;
                    notif.style.backgroundColor = "#fff";
                    notif.style.color = "#333";
                }
            } else {
                notif.innerText = "Ch·ªù Admin m·ªùi ng∆∞·ªùi ch∆°i...";
            }
        }

        function openLixi(index) {
            // Ki·ªÉm tra l∆∞·ª£t tr√™n Server
            getDatabase(app); // Re-ensure db
            const roomRef = ref(db, `rooms/${roomId}`);
            
            // ƒê·ªçc l·∫°i data m·ªõi nh·∫•t ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng sai l∆∞·ª£t (transaction t·ªët h∆°n nh∆∞ng get ƒë∆°n gi·∫£n h∆°n)
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (data.currentTurn !== myId) {
                    alert("Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n!");
                    return;
                }
                if (data.lixis[index].opened) {
                    alert("Bao n√†y ƒë√£ c√≥ ng∆∞·ªùi nhanh tay ch·ªçn r·ªìi!");
                    return;
                }

                // H·ª£p l·ªá -> M·ªü
                const amount = data.lixis[index].amount;
                
                // C·∫≠p nh·∫≠t DB: ƒê√°nh d·∫•u ƒë√£ m·ªü + Reset l∆∞·ª£t
                const updates = {};
                updates[`rooms/${roomId}/lixis/${index}/opened`] = true;
                updates[`rooms/${roomId}/currentTurn`] = null; // H·∫øt l∆∞·ª£t
                updates[`rooms/${roomId}/lastWinner`] = { name: myName, amount: amount, time: Date.now() };
                
                update(ref(db), updates).then(() => {
                    // Hi·ªán popup cho ch√≠nh m√¨nh
                    showResult(amount);
                });

            }, { onlyOnce: true });
        }

        function showResult(amount) {
            document.getElementById('result-amount').innerText = formatMoney(amount);
            document.getElementById('result-modal').classList.remove('hidden');
        }

        // --- UTILS ---
        function parseMoneyInput(str) {
            return str.split(',').map(s => {
                s = s.toLowerCase().trim();
                let m = 1;
                if (s.includes('tr') || s.includes('m')) { m = 1000000; s = s.replace(/[^0-9.]/g,''); }
                else if (s.includes('k')) { m = 1000; s = s.replace(/[^0-9.]/g,''); }
                else { s = s.replace(/[^0-9.]/g,''); }
                return parseFloat(s) * m;
            }).filter(n => n > 0);
        }

        function formatMoney(n) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        }
    </script>
</body>
</html>
